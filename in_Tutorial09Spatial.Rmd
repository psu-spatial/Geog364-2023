---
title: "Worked Example 1 - Background workings"
subtitle: <h5 style="font-style:normal">GEOG-364 - Spatial Analysis</h4>
output: 
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    theme: flatly
---


<style>
p.comment {
background-color: #DBDBDB;
padding: 10px;
border: 1px solid black;
margin-left: 0px;
border-radius: 5px;
font-style: normal;
}

h1.title {
  font-weight: bold;
  font-family: Arial;  
}

h2.title {
  font-family: Arial;  
}

</style>


<style type="text/css">
 TOC {
  font-size: 12px;
  font-family: Arial;
}
</style>

\
```{r setup, include=FALSE,echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message = FALSE,dpi = 300, dev = "svg")

# invisible data read
library(tidyverse)
library(sp)
library(sf)
library(readxl)
library(skimr)
library(tmap)
library(viridis)
library(usmap)
library(rnaturalearth)
library(ggpubr)
library(gridExtra)
library(ceramic)
library(leaflet)
library(leaflet.extras)
library(leaflet.providers)
library(raster)
library(ggmap)
library(dismo)
library(maps)


as.Date_origin <- function(x){
  format.Date(as.Date(x, origin = '1970-01-01'), format = '%b-%d')
}

Sys.setenv(MAPBOX_API_KEY="pk.eyJ1IjoiaGdyZWF0cmV4IiwiYSI6ImNrbmdpNDN6djBkZTQydXBhNDc1enJjZnkifQ.xQWYvOFK5BKQoNWoOacDgA")


```


<style>
p.comment {
background-color: #DBDBDB;
padding: 10px;
border: 1px solid black;
margin-left: 0px;
border-radius: 5px;
font-style: normal;
}

h1.title {
  font-weight: bold;
  font-family: Arial;  
}

h2.title {
  font-family: Arial;  
}

</style>


<style type="text/css">
#TOC {
  font-size: 11px;
  font-family: Arial;
}
</style>

# What is this?

In the next section, I include an example report analysing farmers markets in Iowa.

This is my background workings - all my text are things I might think in my head, you don't need to write all of this.  

You can see what I would actually submit in the next section.


## Set up and libraries

My example tutorial is set in Iowa on farmers markets.  First, set up libraries

```{r, results=FALSE,warning=FALSE,message=FALSE}

library(sp)
library(sf)
library(tidyverse)
library(tmap)
library(readxl)
library(skimr)

```




## Read in the data

Now I will read in my data, on farmers markets in Iowa.  Sometimes adding in the na option helps, so I will try that.


```{r}
IA_farmersmarket   <- readxl::read_excel("./Data/Farmers_Markets_Iowa.xlsx",na="NA")
names(IA_farmersmarket)
```

OK, I can see I have the columns above and if I click on its name in the Environment tab I can see more details. First, I'll take a quick look at the summary.

```{r}
summary(IA_farmersmarket)
```

## Initial quality control

From this, I can see some weird things! 

### 1. Problem with X

Hmm there is a very small longitude value in X that can't exist

```{r}
# get rid of the row with the weird value
# I could also set it to NA
IA_farmersmarket <- IA_farmersmarket[which(IA_farmersmarket$X > -990),]

# and print the summary
summary(IA_farmersmarket[,c("X","Y")])


```

OK that looks better.

### 3. Remove all the rows with missing locations

I know I don't need any row with missing location data, so let's remove

```{r}
IA_farmersmarket <- IA_farmersmarket[complete.cases(IA_farmersmarket$X), ]

IA_farmersmarket <- IA_farmersmarket[complete.cases(IA_farmersmarket$Y), ]

```


## Choose Columns

I don't need all this data, so let's keep things neat.

```{r}
names(IA_farmersmarket)
```


### Check for missing values. 

I quite like the skim function from skimr for this. Here are my columns (same as name command)

```{r}
glimpse(IA_farmersmarket)
```

 - I know from google that FID is a federal identifier that might be useful, so I'll keep that.  
 - Looking at the data, "location" is the full address, so let's remove that.
 - All the data is in Iowa, so let's remove State
 - Open_Hours and Open Dates feels too complicated, so i'm removing them
 
```{r}
IA_farmersmarket <- IA_farmersmarket[,c("X","Y","FID",
                                        "City","County",
                                        "Market_Name",
                                        "Weekday")]
summary(IA_farmersmarket)

```
 



```{r}
# Note, X and Y because that's what the columns are called. 
# I know that it was in lat/long originally, hence the crs
IA_farmersmarket.sf <- st_as_sf(IA_farmersmarket,coords=c("X","Y"),crs=4326)

# And change to a map projection of your choice. I am choosing UTM Iowa
IA_farmersmarket.sf <- st_transform(IA_farmersmarket.sf,3744)

# make a quick plot
tmap_mode("view")
qtm(st_geometry(IA_farmersmarket.sf))

```

### Trouble shooting

You can see in the plot above that there appears to be one point that is not in Iowa. So now I will look at the long/lat columns.

```{r}
summary(IA_farmersmarket$X)
hist(IA_farmersmarket$X)

```

I feel that maybe that point at Long \~ -88 is wrong. Let's take a look.

```{r}

IA_farmersmarket[IA_farmersmarket$X > -90,]

```

I'm guessing there's a typo - so I could just google this and fix it! but for now, let's remove and try again.

```{r}
# choose all the other ones, note the <= instead of >
IA_farmersmarket <- IA_farmersmarket[IA_farmersmarket$X <= -90,]

# Note, X and Y because that's what the columns are called. 
# I know that it was in lat/long originally, hence the crs
IA_farmersmarket.sf <- st_as_sf(IA_farmersmarket,coords=c("X","Y"),crs=4326)

# And change to a map projection of your choice. I am choosing UTM Iowa
IA_farmersmarket.sf <- st_transform(IA_farmersmarket.sf,3744)

# make a quick plot
tmap_mode("view")
qtm(st_geometry(IA_farmersmarket.sf))

```
